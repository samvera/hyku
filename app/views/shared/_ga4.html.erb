<%# Override Hyrax 5.0.3 to use multiple analytics configs, one app wide one and one tenant override %>
<!-- Google tag (gtag.js) -->
<% if Hyrax.config.analytics? %>
  <%
    # Get the tenant-specific analytics ID directly from the current account
    tenant_analytics_id = current_account&.google_analytics_id&.presence

          global_analytics_id = ENV.fetch('GOOGLE_ANALYTICS_ID', nil)
      # Determine which analytics ID to load the gtag.js library with (prefer tenant, fallback to global)
      primary_analytics_id = tenant_analytics_id.present? ? tenant_analytics_id : global_analytics_id

      tenant_value = (current_account&.tenant || "default")
    %>

  <% if primary_analytics_id.present? %>
    <script async src="https://www.googletagmanager.com/gtag/js?id=<%= primary_analytics_id %>"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());

      // Store the original gtag function
      const originalGtag = gtag;
      
      // Create a wrapper that automatically injects our custom parameters
      window.gtag = function() {
        const args = Array.from(arguments);
        
        // If this is an 'event' call, inject our custom parameters
        if (args[0] === 'event' && typeof args[2] === 'object') {
          args[2] = args[2] || {};
          args[2].debug_mode = true;
          args[2].tenant_id = '<%= tenant_value %>';
        }
        
        // Call the original gtag function with the modified arguments
        return originalGtag.apply(this, args);
      };


<% if tenant_analytics_id.present? %>
        gtag('config', '<%= tenant_analytics_id %>', { 'send_page_view': false });
      <% end %>

      // Configure the global property (if available and different from tenant)
      <% if global_analytics_id.present? %>
        gtag('config', '<%= global_analytics_id %>', { 'send_page_view': false });
      <% end %>

      // Now send our own page_view event with the parameters
      gtag('event', 'page_view', {});

      // Optional: make gtag accessible elsewhere
      window.analytics = gtag;
    </script>
    <meta name="analytics-provider" content="ga4">
    <meta name="analytics-tenant" content="<%= tenant_value %>">
  <% end %>
<% end %>
